name: "Repository Traffic Analytics"

on:
  schedule:
    - cron: '10 0 * * *' 
  workflow_dispatch:

jobs:
  analyze-traffic:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        with:
          path: main-repo

      - name: Checkout Data Repo
        uses: actions/checkout@v4
        with:
          repository: DavidShiang/davidshiang-metrics-data
          token: ${{ secrets.DEEPSEEK2MD_STATS }}
          path: data-repo

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pandas matplotlib

      - name: Fetch and Update Data
        env:
          GH_TOKEN: ${{ secrets.DEEPSEEK2MD_STATS }}
        run: |
          REPO="DavidShiang/DeepSeek2md"
          DATE=$(date +%Y-%m-%d)
          
          # 获取 API 数据
          curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$REPO/traffic/views" > views.json
          curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$REPO/traffic/clones" > clones.json
          
          V_COUNT=$(jq -r '.count // 0' views.json)
          C_COUNT=$(jq -r '.count // 0' clones.json)
          
          # 路径指向数据仓库
          CSV_FILE="data-repo/DeepSeek2md_traffic_history.csv"
          
          if [ ! -f "$CSV_FILE" ]; then
            echo "Date,Views,Clones" > "$CSV_FILE"
          fi

          echo "$DATE,$V_COUNT,$C_COUNT" >> "$CSV_FILE"

          # 保护表头并去重排序
          head -n 1 "$CSV_FILE" > temp.csv
          tail -n +2 "$CSV_FILE" | sort -u -t, -k1,1 >> temp.csv
          mv temp.csv "$CSV_FILE"

      - name: Generate Chart
        shell: python
        run: |
          import pandas as pd
          import matplotlib.pyplot as plt
          import matplotlib.dates as mdates
          import os

          # 明确指向数据仓库中的文件
          csv_path = 'data-repo/DeepSeek2md_traffic_history.csv'
          img_path = 'data-repo/DeepSeek2md_traffic_chart.png'

          try:
              # 1. 加载数据
              df = pd.read_csv(csv_path)
              print(f"Columns found: {df.columns.tolist()}")
              
              if 'Date' not in df.columns:
                  df.columns = ['Date', 'Views', 'Clones']

              df['Date'] = pd.to_datetime(df['Date'])
              df = df.sort_values('Date').drop_duplicates('Date')

              # 2. 设置固定尺寸的画布 (1000x500 像素)
              fig, ax = plt.subplots(figsize=(10, 5), dpi=100)
              
              # 3. 绘制折线
              ax.plot(df['Date'], df['Views'], marker='.', markersize=4, 
                      label='Views', color='#007bff', linewidth=1.5, alpha=0.8)
              ax.plot(df['Date'], df['Clones'], marker='.', markersize=4, 
                      label='Clones', color='#28a745', linewidth=1.5, alpha=0.8)

              # 4. 【核心优化】动态调整 X 轴日期显示
              # 根据时间跨度自动选择间隔，防止标签重叠
              ax.xaxis.set_major_formatter(mdates.DateFormatter('%m-%d'))
              ax.xaxis.set_major_locator(mdates.AutoDateLocator())
              
              # 自动旋转日期标签
              fig.autofmt_xdate()
              
              # 5. 图表修饰
              plt.title(f'DeepSeek2md Traffic ({df["Date"].min().strftime("%Y/%m/%d")} - {df["Date"].max().strftime("%Y/%m/%d")})', 
                        fontsize=12, pad=15)
              ax.grid(True, linestyle=':', alpha=0.5)
              ax.set_facecolor('#f8f9fa') # 给图表一个浅色背景，更有质感
              ax.legend(loc='upper left', frameon=True, shadow=True)

              # 6. 保存并确保尺寸固定
              plt.tight_layout()
              plt.savefig(img_path, bbox_inches='tight')
              print(f"Chart generated from {df['Date'].min()} to {df['Date'].max()}")
              
          except Exception as e:
              print(f"Detailed Error: {e}")
              raise

      - name: Commit and Push to Data Repo
        run: |
          cd data-repo
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -f DeepSeek2md_traffic_chart.png ]; then
            git add DeepSeek2md_traffic_history.csv DeepSeek2md_traffic_chart.png
            git commit -m "update traffic logs from DeepSeek2md [skip ci]" || echo "No changes"
            git push
          else
            echo "Error: DeepSeek2md_traffic_chart.png not found!"
            exit 1
          fi
