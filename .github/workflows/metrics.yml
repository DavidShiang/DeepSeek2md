name: "Repository Traffic Analytics"

on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch:

jobs:
  analyze-traffic:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pandas matplotlib

      - name: Fetch and Update Data
        env:
          GH_TOKEN: ${{ secrets.DEEPSEEK2MD_STATS }}
        run: |
          # 1. 获取数据 (使用当前环境路径)
          REPO="DavidShiang/DeepSeek2md"
          DATE=$(date +%Y-%m-%d)
          
          VIEWS=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$REPO/traffic/views" | jq -r '.count // 0')
          CLONES=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$REPO/traffic/clones" | jq -r '.count // 0')
          
          # 2. 写入或追加 CSV
          if [ ! -f traffic_history.csv ]; then
            echo "Date,Views,Clones" > traffic_history.csv
          fi
          echo "$DATE,$VIEWS,$CLONES" >> traffic_history.csv
          
          # 3. 去重排序
          sort -u -t, -k1,1 traffic_history.csv -o traffic_history.csv

      - name: Generate Chart
        shell: python # 直接指定 shell 为 python，避免 YAML 解析字符串的痛苦
        run: |
          import pandas as pd
          import matplotlib.pyplot as plt
          
          try:
              df = pd.read_csv('traffic_history.csv')
              df['Date'] = pd.to_datetime(df['Date'])
              df = df.sort_values('Date')

              # 绘图逻辑
              plt.figure(figsize=(10, 5))
              plt.plot(df['Date'], df['Views'], marker='o', label='Views', color='#007bff', linewidth=2)
              plt.plot(df['Date'], df['Clones'], marker='s', label='Clones', color='#28a745', linewidth=2)
              
              plt.title('DavidShiang/DeepSeek2md Traffic Trend', fontsize=14)
              plt.grid(True, alpha=0.3)
              plt.legend()
              plt.tight_layout()
              
              plt.savefig('traffic_chart.png', dpi=100)
          except Exception as e:
              print(f"Error generating chart: {e}")

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add traffic_history.csv traffic_chart.png
          git commit -m "update traffic statistics [skip ci]" || exit 0
          git push
