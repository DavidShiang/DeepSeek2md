name: "Repository Traffic Analytics"

on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch:

jobs:
  analyze-traffic:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        with:
          path: main-repo

      - name: Checkout Data Repo
        uses: actions/checkout@v4
        with:
          repository: DavidShiang/davidshiang-metrics-data
          token: ${{ secrets.DEEPSEEK2MD_STATS }}
          path: data-repo

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pandas matplotlib

      - name: Fetch and Update Data
        env:
          GH_TOKEN: ${{ secrets.DEEPSEEK2MD_STATS }}
        run: |
          REPO="DavidShiang/DeepSeek2md"
          DATE=$(date +%Y-%m-%d)
          
          # 获取 API 数据
          curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$REPO/traffic/views" > views.json
          curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$REPO/traffic/clones" > clones.json
          
          V_COUNT=$(jq -r '.count // 0' views.json)
          C_COUNT=$(jq -r '.count // 0' clones.json)
          
          # 路径指向数据仓库
          CSV_FILE="data-repo/DeepSeek2md_traffic_history.csv"
          
          if [ ! -f "$CSV_FILE" ]; then
            echo "Date,Views,Clones" > "$CSV_FILE"
          fi

          echo "$DATE,$V_COUNT,$C_COUNT" >> "$CSV_FILE"

          # 保护表头并去重排序
          head -n 1 "$CSV_FILE" > temp.csv
          tail -n +2 "$CSV_FILE" | sort -u -t, -k1,1 >> temp.csv
          mv temp.csv "$CSV_FILE"

      - name: Generate Chart
        shell: python
        run: |
          import pandas as pd
          import matplotlib.pyplot as plt
          import os

          # 明确指向数据仓库中的文件
          csv_path = 'data-repo/DeepSeek2md_traffic_history.csv'
          img_path = 'data-repo/DeepSeek2md_traffic_chart.png'

          try:
              df = pd.read_csv(csv_path)
              print(f"Columns found: {df.columns.tolist()}")
              
              if 'Date' not in df.columns:
                  df.columns = ['Date', 'Views', 'Clones']

              df['Date'] = pd.to_datetime(df['Date'])
              df = df.sort_values('Date')

              plt.figure(figsize=(10, 5))
              plt.plot(df['Date'], df['Views'], marker='o', label='Views', color='#007bff')
              plt.plot(df['Date'], df['Clones'], marker='s', label='Clones', color='#28a745')
              
              plt.title('DeepSeek2md Traffic Stats', fontsize=14)
              plt.grid(True, alpha=0.3)
              plt.legend()
              plt.xticks(rotation=45)
              plt.tight_layout()
              
              plt.savefig(img_path)
              print("Chart saved successfully.")
          except Exception as e:
              print(f"Detailed Error: {e}")
              raise

      - name: Commit and Push to Data Repo
        run: |
          cd data-repo
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -f traffic_chart.png ]; then
            git add traffic_history.csv DeepSeek2md_traffic_chart.png
            git commit -m "update traffic logs from DeepSeek2md [skip ci]" || echo "No changes"
            git push
          else
            echo "Error: DeepSeek2md_traffic_chart.png not found!"
            exit 1
          fi
