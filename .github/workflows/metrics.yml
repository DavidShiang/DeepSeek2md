name: "Repository Traffic Analytics"

on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch:

jobs:
  analyze-traffic:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pandas matplotlib

      - name: Fetch and Update Data
        env:
          GH_TOKEN: ${{ secrets.DEEPSEEK2MD_STATS }}
        run: |
          REPO="DavidShiang/DeepSeek2md"
          DATE=$(date +%Y-%m-%d)
          
          # 获取数据并直接写入文件，避免复杂的变量传递
          curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$REPO/traffic/views" > views.json
          curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$REPO/traffic/clones" > clones.json
          
          V_COUNT=$(jq -r '.count // 0' views.json)
          C_COUNT=$(jq -r '.count // 0' clones.json)
          
          # 2. 如果文件不存在，初始化表头
          if [ ! -f traffic_history.csv ]; then
            echo "Date,Views,Clones" > traffic_history.csv
          fi

          # 3. 将新数据存入临时文件
          echo "$DATE,$V_COUNT,$C_COUNT" >> traffic_history.csv

          # 4. 【核心修复】：保留第一行表头，对剩余行进行排序去重
          head -n 1 traffic_history.csv > temp.csv
          tail -n +2 traffic_history.csv | sort -u -t, -k1,1 >> temp.csv
          mv temp.csv traffic_history.csv

      - name: Generate Chart
        shell: python
        run: |
          import pandas as pd
          import matplotlib.pyplot as plt
          import os

          # 获取当前工作目录
          cwd = os.getcwd()
          csv_path = os.path.join(cwd, 'traffic_history.csv')
          img_path = os.path.join(cwd, 'traffic_chart.png')

          try:
              # 读取时强制指定列名或检查
              df = pd.read_csv('traffic_history.csv')

              # 打印一下列名，方便在 Logs 里排错
              print(f"Columns found: {df.columns.tolist()}")
              
              if 'Date' not in df.columns:
                  # 如果因为某种原因还是没找到 Date，尝试手动修复索引
                  df.columns = ['Date', 'Views', 'Clones']

              df['Date'] = pd.to_datetime(df['Date'])
              df = df.sort_values('Date')

              plt.figure(figsize=(10, 5))
              plt.plot(df['Date'], df['Views'], marker='o', label='Views', color='#007bff')
              plt.plot(df['Date'], df['Clones'], marker='s', label='Clones', color='#28a745')
              
              plt.title('DeepSeek2md Traffic Stats', fontsize=14)
              plt.grid(True, alpha=0.3)
              plt.legend()
              plt.xticks(rotation=45)
              plt.tight_layout()
              
              plt.savefig('traffic_chart.png')
          except Exception as e:
              print(f"Detailed Error: {e}")
              raise

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # 检查文件是否存在，防止提交报错
          if [ -f traffic_chart.png ]; then
            git add traffic_history.csv traffic_chart.png
            git commit -m "update traffic logs [skip ci]" || echo "No changes"
            git push
          else
            echo "Error: traffic_chart.png not found!"
            exit 1
          fi
